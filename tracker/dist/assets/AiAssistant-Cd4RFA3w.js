import{r as p,J as S,a as R,R as I,K as E,j as u,L as V,e as j,M as L,N as _}from"./index-hdv4Cp5W.js";var T=new Map,x=new WeakMap,C=0,U=void 0;function F(r){return r?(x.has(r)||(C+=1,x.set(r,C.toString())),x.get(r)):"0"}function K(r){return Object.keys(r).sort().filter(e=>r[e]!==void 0).map(e=>`${e}_${e==="root"?F(r.root):r[e]}`).toString()}function M(r){const e=K(r);let t=T.get(e);if(!t){const c=new Map;let a;const d=new IntersectionObserver(l=>{l.forEach(i=>{var o;const b=i.isIntersecting&&a.some(y=>i.intersectionRatio>=y);r.trackVisibility&&typeof i.isVisible>"u"&&(i.isVisible=b),(o=c.get(i.target))==null||o.forEach(y=>{y(b,i)})})},r);a=d.thresholds||(Array.isArray(r.threshold)?r.threshold:[r.threshold||0]),t={id:e,observer:d,elements:c},T.set(e,t)}return t}function Y(r,e,t={},c=U){if(typeof window.IntersectionObserver>"u"&&c!==void 0){const o=r.getBoundingClientRect();return e(c,{isIntersecting:c,target:r,intersectionRatio:typeof t.threshold=="number"?t.threshold:0,time:0,boundingClientRect:o,intersectionRect:o,rootBounds:o}),()=>{}}const{id:a,observer:d,elements:l}=M(t),i=l.get(r)||[];return l.has(r)||l.set(r,i),i.push(e),d.observe(r),function(){i.splice(i.indexOf(e),1),i.length===0&&(l.delete(r),d.unobserve(r)),l.size===0&&(d.disconnect(),T.delete(a))}}function z({threshold:r,delay:e,trackVisibility:t,rootMargin:c,root:a,triggerOnce:d,skip:l,initialInView:i,fallbackInView:o,onChange:b}={}){var y;const[A,k]=p.useState(null),s=p.useRef(b),[v,f]=p.useState({inView:!!i,entry:void 0});s.current=b,p.useEffect(()=>{if(l||!A)return;let N;return N=Y(A,(P,D)=>{f({inView:P,entry:D}),s.current&&s.current(P,D),D.isIntersecting&&d&&N&&(N(),N=void 0)},{root:a,rootMargin:c,threshold:r,trackVisibility:t,delay:e},o),()=>{N&&N()}},[Array.isArray(r)?r.toString():r,A,a,c,d,l,t,o,e]);const n=(y=v.entry)==null?void 0:y.target,m=p.useRef(void 0);!A&&n&&!d&&!l&&m.current!==n&&(m.current=n,f({inView:!!i,entry:void 0}));const h=[k,v.inView,v.entry];return h.ref=h[0],h.inView=h[1],h.entry=h[2],h}class g{static instance;cache;CACHE_DURATION=300*1e3;DEBOUNCE_DELAY=300;DEFAULT_CHUNK_SIZE=15;DEFAULT_CHUNK_DELAY=30;DEFAULT_MAX_RETRIES=3;DEFAULT_RETRY_DELAY=1e3;debounceTimer=null;abortController=null;streamInterval=null;constructor(){this.cache=new Map}static getInstance(){return g.instance||(g.instance=new g),g.instance}getCacheKey(e){return e.trim().toLowerCase()}isCacheValid(e){return Date.now()-e.timestamp<this.CACHE_DURATION}async retryRequest(e,t,c,a){let d=null;for(let l=1;l<=t;l++)try{return await e()}catch(i){if(d=i instanceof Error?i:new Error("Unknown error"),i instanceof S){if(i.response?.status===404)throw new Error("AI service endpoint not found. Please check the API configuration.");if(i.response?.status===500){const o=i.response.data?.message||"AI service error";throw new Error(o)}}l<t&&(a?.(l),await new Promise(o=>setTimeout(o,c*l)))}throw d||new Error("Request failed after all retries")}async getAIResponse(e){const t=this.getCacheKey(e),c=this.cache.get(t);if(c&&this.isCacheValid(c))return c.response;try{const a=await this.retryRequest(()=>R.post("/api/ai/ask",{prompt:e}),this.DEFAULT_MAX_RETRIES,this.DEFAULT_RETRY_DELAY);return this.cache.set(t,{response:a.data,timestamp:Date.now(),retryCount:0}),a.data}catch(a){throw console.error("AI request failed:",a),a}}async streamAIResponse(e,t,c={}){const{chunkSize:a=this.DEFAULT_CHUNK_SIZE,chunkDelay:d=this.DEFAULT_CHUNK_DELAY,maxRetries:l=this.DEFAULT_MAX_RETRIES,retryDelay:i=this.DEFAULT_RETRY_DELAY}=c;this.cancelStream(),this.abortController=new AbortController;try{const o=await this.retryRequest(()=>R.post("/api/ai/ask",{prompt:e},{signal:this.abortController?.signal}),l,i,t.onRetry);if(!o.data||!o.data.response)throw new Error("Invalid response format");const b=o.data.response;let y=0;this.streamInterval=setInterval(()=>{if(y>=b.length){this.cleanupStream(),t.onComplete();return}const k=b.slice(y,y+a);y+=a,t.onData(k)},d);const A=this.getCacheKey(e);this.cache.set(A,{response:{message:b},timestamp:Date.now(),retryCount:0})}catch(o){this.cleanupStream(),o instanceof Error&&o.name==="AbortError"?console.log("Request was aborted"):t.onError(o instanceof Error?o:new Error("Unknown error occurred"))}}cleanupStream(){this.streamInterval&&(clearInterval(this.streamInterval),this.streamInterval=null),this.abortController=null}debouncedGetAIResponse(e){return new Promise((t,c)=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{try{const a=await this.getAIResponse(e);t(a)}catch(a){c(a)}},this.DEBOUNCE_DELAY)})}cancelStream(){this.abortController&&this.abortController.abort(),this.cleanupStream()}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,hitCount:Array.from(this.cache.values()).filter(e=>e.retryCount===0).length}}}const w=g.getInstance(),O=()=>{const[r,e]=p.useState([]),[t,c]=p.useState(""),[a,d]=p.useState(!1),l=p.useRef(null),{ref:i}=z({threshold:.5,onChange:s=>{}}),o=p.useCallback(()=>{l.current?.scrollIntoView({behavior:"smooth"})},[]);p.useEffect(()=>{o()},[r,o]);const b=p.useCallback(async s=>{if(s.preventDefault(),!t.trim()||a)return;const v={id:Date.now().toString(),content:t.trim(),role:"user",timestamp:Date.now()},f={id:(Date.now()+1).toString(),content:"",role:"assistant",timestamp:Date.now(),isStreaming:!0,retryCount:0};e(n=>[...n,v,f]),c(""),d(!0);try{await w.streamAIResponse(t.trim(),{onData:n=>{e(m=>m.map(h=>h.id===f.id?{...h,content:h.content+n}:h))},onError:n=>{console.error("AI response error:",n),e(m=>m.map(h=>h.id===f.id?{...h,content:h.content+`

Error: `+n.message,isStreaming:!1,error:!0}:h)),E.error(n.message||"Failed to get AI response. Please try again.")},onComplete:()=>{e(n=>n.map(m=>m.id===f.id?{...m,isStreaming:!1}:m)),d(!1)},onRetry:n=>{E.loading(`Retrying... (${n}/3)`,{id:"retry-toast"})}},{chunkSize:15,chunkDelay:30,maxRetries:3,retryDelay:1e3})}catch(n){E.error("Failed to get AI response. Please try again."),console.error("AI response error:",n),d(!1)}},[t,a]),y=p.useCallback(s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),b(s))},[b]),A=p.useCallback(()=>{w.cancelStream(),d(!1),e(s=>s.map(v=>v.isStreaming?{...v,isStreaming:!1}:v)),E.dismiss("retry-toast")},[]),k=p.useCallback(s=>{const v=r.find(f=>f.id===s);v&&(e(f=>f.map(n=>n.id===s?{...n,isStreaming:!0,error:!1,retryCount:(n.retryCount||0)+1}:n)),w.streamAIResponse(v.content,{onData:f=>{e(n=>n.map(m=>m.id===s?{...m,content:m.content+f}:m))},onError:f=>{console.error("AI response error:",f),e(n=>n.map(m=>m.id===s?{...m,content:m.content+`

Error: `+f.message,isStreaming:!1,error:!0}:m)),E.error(f.message||"Failed to get AI response. Please try again.")},onComplete:()=>{e(f=>f.map(n=>n.id===s?{...n,isStreaming:!1}:n))}},{chunkSize:15,chunkDelay:30,maxRetries:3,retryDelay:1e3}))},[r]);return u.jsxDEV("div",{className:"flex flex-col h-full max-w-4xl mx-auto",children:[u.jsxDEV("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[r.map(s=>u.jsxDEV("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:u.jsxDEV("div",{className:`max-w-[80%] rounded-lg p-4 ${s.role==="user"?"bg-primary-500 text-white":s.error?"bg-red-50 dark:bg-red-900/20":"bg-gray-100 dark:bg-gray-800"}`,children:[u.jsxDEV("p",{className:"whitespace-pre-wrap",children:s.content},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:202,columnNumber:15},void 0),s.isStreaming&&u.jsxDEV("div",{className:"flex items-center mt-2",children:[u.jsxDEV(V,{className:"animate-spin h-4 w-4 mr-2"},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:205,columnNumber:19},void 0),u.jsxDEV("span",{className:"text-xs opacity-70",children:"AI is typing..."},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:206,columnNumber:19},void 0),u.jsxDEV("button",{onClick:A,className:"ml-2 p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full",children:u.jsxDEV(j,{className:"h-4 w-4"},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:211,columnNumber:21},void 0)},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:207,columnNumber:19},void 0)]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:204,columnNumber:17},void 0),s.error&&u.jsxDEV("div",{className:"flex items-center mt-2",children:u.jsxDEV("button",{onClick:()=>k(s.id),className:"flex items-center text-xs text-red-500 hover:text-red-600",children:[u.jsxDEV(L,{className:"h-4 w-4 mr-1"},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:221,columnNumber:21},void 0),"Retry"]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:217,columnNumber:19},void 0)},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:216,columnNumber:17},void 0),u.jsxDEV("span",{className:"text-xs opacity-70 mt-1 block",children:new Date(s.timestamp).toLocaleTimeString()},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:226,columnNumber:15},void 0)]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:193,columnNumber:13},void 0)},s.id,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:187,columnNumber:11},void 0)),u.jsxDEV("div",{ref:l},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:232,columnNumber:9},void 0),u.jsxDEV("div",{ref:i},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:233,columnNumber:9},void 0)]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:185,columnNumber:7},void 0),u.jsxDEV("form",{onSubmit:b,className:"p-4 border-t dark:border-gray-700",children:u.jsxDEV("div",{className:"flex space-x-4",children:[u.jsxDEV("textarea",{value:t,onChange:s=>c(s.target.value),onKeyPress:y,placeholder:"Type your message...",className:"flex-1 p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-500",rows:1,style:{resize:"none"}},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:238,columnNumber:11},void 0),u.jsxDEV("button",{type:"submit",disabled:a||!t.trim(),className:"px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed",children:u.jsxDEV(_,{className:"h-5 w-5"},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:252,columnNumber:13},void 0)},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:247,columnNumber:11},void 0)]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:237,columnNumber:9},void 0)},void 0,!1,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:236,columnNumber:7},void 0)]},void 0,!0,{fileName:"/home/enock/Personal-Productivity-Tracker/tracker/src/pages/AiAssistant.tsx",lineNumber:184,columnNumber:5},void 0)},H=I.memo(O);export{H as default};
